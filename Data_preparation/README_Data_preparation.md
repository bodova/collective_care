# Data preparation

## Get started
* You'll need Python 3. The *requirements.txt* file lists all Python libraries that the pg scripts depend on, and they will be installed using `pip install -r requirements.txt`. You may need to install python3-tk (`sudo apt install python3-tk`).
* The repository comes with a subset of the data (./data/raw/) sufficient to execute all analysis steps and a sample script (./scripts/sampleAnalysis.py) to run them.

## TLDR; 
* Open a terminal and run the sample script: python scripts/sampleAnalysis.py
* You will see the output folder become populated with analysis-ready data files just like those
used as input for the analysis scripts in this repository, except they contain data only for the sample set provided. 
* Use config to adjust the steps to run in the pipeline and the parameters used.

### Sample input data (further expanded at the end of this document)
* The expected input data consists of the following components:
1. **Raw annotation files**.
The raw output generated by the behavioural annotation software (Solomon coder)
2. **Experimental spore load measurements.** A table containing the experimental measurements and associated experimental identifiers for the measured individuals
3. **Experimental key.** A key to match individuals by their color and replicate information (coded with Roman numerals) to their corresponding individual and group treatment
4. **Metadata.** related to the video and annotation process, such as details on the frame where the annotation started and stopped for both the 30-minute baseline observation period and the 90-minute post-treatment observation period.


## Execute the preparation pipeline
(Running time: 2 minutes on the test data)
1. *Adjust configuration paths and parameters*. This repository includes a configuration file (`config_tests.py`) to execute all analyses on the provided sample data. This file contains default configuration settings,  as python variables: 1) input (read-only) directories wherein to find the expected input data, 2) output directories on which to place the results, 3) the pipeline steps that we want to execute, and additional parameters.

All file paths are relative to a base directory specified in the 'basedir' variable, which should be set to the directory where the data is located (e.g. in this repository, base_dir = './data/' which is where the test data can be found).

The steps one can choose from and the parameters needed are summarised in two tables below.

| pipeline steps|  description |  
| ------------- |:--------------------|
| windowed_tables | Creates windowed time series of a given behavior for each ant|
| windowed_tables_pairwise | Creates windowed time series of a given behavior for each pair of ants involved |
| build_all_tables | Creates a list of all behavioral events for each replicate and a table with aggregated statistics |
| plot_choice_distribution | Creates list all grooming choices, with their duration and computes the spore ratio between target and non-target individual (see NOTE) 
 |

NOTE: The final step in the pipeline is to run 'plot_choice_distribution',
 which requires output generated in previous steps. Specifically, it uses files 
produced by 'build_all_tables' (EVENTS*.csv) and a table
 (./data/intermediate/POST_windowed_450_groomTot_spore_MM_paper.csv') containing a
 time series of estimated current spore loads (as described in
 Modeling_and_simulations/MM_backcomputation). The creation of this table requires
 files generated by the 'windowed_tables' step (POST_windowed_450_groomTot.csv).


| parameters|  description |
| ------------- |:--------------------|
| windowSizeInFrames| The size of window for windowed functions|
| secondOnlyTreated | The pairwise windowed tables will only include a row for pairs of ants the second of which (receptor of the behavior) is treated. |
| eventStartCount | The windowed timeseries will not count the number of frames that a behaviour is taking place in a given window, instead, it will count how many events started in said window.
| eventEndtCount | The windowed timeseries will not count the number of frames that a behaviour is taking place in a given window, instead, it will count how many events started in said window.

2. *Run the pipeline!* In the `/Preparation/` directory execute `python scripts/sampleAnalysis.py`. This will execute several analyses using the provided example data. The output is described in detail below.



### Output tables
After successfully executing the preparation pipeline you will obtain a number of tables

##### Event tables (e.g.EVENTS_POST_HH_1.csv)<a name="eventables"></a>
The file names include information about the treatment, replicate, and observation period. Each experimental dish has two files (PRE and POST), and each row in the files represents an annotated behavioral event.

| variable name | content description | example |
| ------------- |:-------------| :-------------|
|treat| one of six treatment groups, two-letter string| HH|
|rep| replicate|1|
|start| start frame of a given action|1189|
|duration| duration in frames of the given action|536|
|actor|colormark of the ant performing the action|yellow|
|treatmentA|treatment of the ant performing the action, untreated(N),mRFP spore-treated(R), eGFP spore treated (G), triton-x sham treated (T)|N|
|levelA| level of the treamtment, high(H),low(L), or else (X)|X|
|behaviour| behavioural annotation of interest: antennal stroke (A),grooming(G), body grooming(S),gaster tip grooming(R),head grooming(H) |G|
|receiver|colormark of the ant receiving the action, if self-grooming actor=receiver|green|
|treatmentR|treatment of the ant receiving the action |G|
|levelR|level of the treatment |H|

##### Aggregated table (G_all.csv)
This table combines the individual spore measurements and different annotated behaviors, using the experimental key and metadata. Each row corresponds to one ant. All replicates from different treatment groups, and from both observation periods are gathered in a single table.

| variable name | content description | example |
| ------------- |:-------------| :------------|
|treatmentgroup| one of six treatment groups, two-letter string| HL|
|replicate|replicate|1|
|period|observation period, PRE: before treatment, POST: after treatment|PRE|
|color|colormark of the ant |yellow|
|treatment|individual treatment of the ant, untreated(N),mRFP1 spore-treated(R), eGFP spore treated (G), triton-x sham treated (T)|N|
|level| level of the treatment, high(H),low(L), or else (X)|X|
|headRFP| final load of mRFP1-labelled spores from its head, from ddpcr dataset|
|headGFP| final load of eGFP-labelled spores from its head, from ddpcr dataset|
|bodyRFP| final load of mRFP1-labelled spores from its body, from ddpcr dataset|
|bodyGFP| final load of eGFP-labelled spores from its body, from ddpcr dataset|
|gaster| poison uptake from gaster tip gland, from Solomon dataset
|other| from Solomon dataset
|antenna|antennal strokes, from Solomon dataset
|head|self grooming of head and mouthparts, from Solomon dataset
|selfG| self grooming of the body, from Solomon dataset
|groomIn| allo grooming received, from Solomon dataset
|groomOut| allo grooming performed, from Solomon dataset
|totGroomIn| total grooming received (including body self) , from Solomon dataset
|totGroomOut|total grooming performed (including body self), from Solomon dataset
|groomToR| grooming towards a spore exposed ant with mRFP labelled spores, from Solomon dataset
|groomToG| grooming towards a spore exposed ant with eGFP labelled spores, from Solomon dataset
|groomToT| grooming directed towards a control-treated ant, from Solomon dataset
|rankGroomInGeneral| ranking based on the grooming received from others, out of all six ants
|rankGroomInParticular| ranking based on the grooming received from others, among nestmates if a nestmate {1:4}, or among treated if it is one of the two treated {1,2}.
|rankGroomOutGeneral| ranking based on the grooming performed towards others
|rankGroomOutParticular| ranking based on the grooming performed towards others

##### Windowed tables (e.g. POST_windowed_450_groomTot.csv)
These tables (one per observation period, PRE or POST, and included in the filename) contain one row per ant, with identifiers for its experimental group (i.e. ants from different experimental groups are gathered in a single table) and its final measured spore load (from the spore dataset), and the rest of the columns correspond to windows of a time series. The values in the timeseries are of two types:(a) counts of frames of the selected behaviors happening in each window (b) counts of start events of the selected behavior. 

 They are created all at once if the pipeline steps in config_tests.py include build_all_tables. The are created by a generic function, that can be run as standalone as following:

`d = tB.buildWindowedTables (treatmentReplicatePairs,outFolder,behaviourType,windowSizeInFrames, solomonDir)`

'behaviourType' is what determines the content of the time series and is included in the filename. Also included in the filename is the window size in frames.

| behaviourType | description |
| ------------- |:-------------|
|groomIn | number of frames of allog rooming received |
|groomOut| number of frames of allog rooming performed |
|groomTot| number of frames of grooming received (including body self grooming)|

| variable name | content description | example |
| ------------- |:--------------------| :-----|
|treatmentgroup| one of six treatment groups, two-letter string| HL|
|replicate|replicate|1|
|color|colormark of the ant |yellow|
|treatment|individual treatment of the ant, untreated(N),mRFP1 spore-treated(R), eGFP spore treated (G), triton-x sham treated (T)|N|
|level| level of the treatment, high(H),low(L), or else (X)|X|
|headRFP| final load of mRFP1-labelled spores from its head, from ddpcr|.|
|headGFP| final load of eGFP-labelled spores from its head from ddpcr|.|
|bodyRFP| final load of mRFP1-labelled spores from its body from ddpcr|.|
|bodyGFP| final load of eGFP-labelled spores from its body from ddpcr|.|
|window 1|...|.|

##### Paired windows tables (e.g. POST_windowed_450_outPairwise.csv)
They are similar to the windowed tables described above, except that they have a row for every pair of ants. The values of the time series count the number of registered interactions of a given type between each pair of ants.

### Input tables (in detail)
###### 1. Raw behavioral annotation files <a name="rawannotation"></a>
 Documented by the authors [here](http://solomon.andraspeter.com/help.html). Sample file provided in this repository are (HH_rep1_camA_bat1.arch, HL_rep16_camA_bat2.arch, TxTx_rep18_camD_bat4.arch)
 

###### 2.  Experimental spore load measurements (IDE_ddPCR_results_final.csv) <a name="sporedataset"></a>
| variable name | content description | example |
| ------------- |:-------------| :-----|
|Replicate| replicate |1|
|Dish|Roman numeral from I to VI, since experiment was run blind to treatment|I|
|Colour|colormark of the ant for which spores were quantified |blue|
|part|spores were quantified separately for the head and the body of the ant|head|
|ch1| spores had a molecular label fluorescent in one of two channels, this value corresponds to a spore count of mRFP1 spores |1125|
|ch2| spores had a molecular label fluorescent in one of two channels ,this value corresponds to a spores count of eGFP spores |10725|

###### 3. Experimental data key (IDE_ddPCR_key.csv) <a name="key"></a>
| variable name | content description | example |
| ------------- |:-------------| :-----|
|Treatment| one of six treatment groups, the name is given by the two treated ants|HH|
|Replicate| replicate|1|
|Dish| Roman numeral from I to VI, since experiment was run blind to treatment| VI|
|TreatedA|two letter string, indicating treatment with high(H) or a (L) dose, using labelled spores(g, r), or sham (Tt)|Lr|
|colorA|colormark of one treated ant |orange|
|TreatedB|two letter string, indicating treatment as TreatedA|Lg|
|colorB|colormark of the second treated ant|yellow|

###### 4. Metadata (behavioural_coding_metadata.csv)  <a name="metadata"></a>
| variable name | content description | example |
| ------------- |:-------------| :-----|
|treatment|treatment group, the name is given by the two treated ants|HH|
|rep|replicate|1|
|day|experimental filming day|1|
|camera|experiments were filmed with four camera setups in parallel (A,B,C,D)|A|
|batch|experiments were filmed in batches (up to five in one day)|1|
|date_finished|annotations were finished on this date |11/24/2016|
|before_start|there was two observation periods, before and after treatment of two ants, the first was annotated starting on this frame (filmed at 15fps) |0|
|before_end|the annotation of this period ended on this frame|28029|
|after_start|the second observation period started on this frame|35750|
|after_end|the second observation period ended on this frame|117475|


